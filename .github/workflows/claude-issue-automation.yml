name: Claude Issue Automation
# Automatically handle GitHub issues with @claude mentions
# Based on: https://github.com/anthropics/claude-code-action

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    # Only run if issue contains @claude mention or has 'claude-code' label
    if: |
      contains(github.event.issue.body, '@claude') ||
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.issue.labels.*.name, 'claude-code')

    steps:
      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Automatically implement the issue
          prompt: |
            An issue has been filed: "${{ github.event.issue.title }}"

            Issue description:
            ${{ github.event.issue.body }}

            Please:
            1. Analyze the issue and understand what needs to be done
            2. Implement the necessary code changes
            3. Write or update tests as needed
            4. Ensure the changes follow project conventions from CLAUDE.md
            5. Create a pull request with a clear description

            If the issue is unclear, ask for clarification by commenting on the issue.

          mode: auto
          model: claude-sonnet-4-5-20250929
          max_tokens: 16000

      - name: Label Issue as In Progress
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['claude-in-progress']
            });
