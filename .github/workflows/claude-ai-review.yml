name: Claude AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: false
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

concurrency:
  group: claude-review-${{ github.ref }}
  cancel-in-progress: false

jobs:
  code-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Environment
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number || github.event.inputs.pr_number }}" >> $GITHUB_ENV
          echo "BASE_SHA=${{ github.event.pull_request.base.sha || github.event.before }}" >> $GITHUB_ENV
          echo "HEAD_SHA=${{ github.event.pull_request.head.sha || github.sha }}" >> $GITHUB_ENV

      - name: Generate Diff Context
        id: diff
        run: |
          git diff ${{ env.BASE_SHA }}..${{ env.HEAD_SHA }} > pr_diff.txt
          echo "diff_size=$(wc -l < pr_diff.txt)" >> $GITHUB_OUTPUT

          # Get list of modified files
          git diff --name-only ${{ env.BASE_SHA }}..${{ env.HEAD_SHA }} > modified_files.txt
          echo "files_changed=$(wc -l < modified_files.txt)" >> $GITHUB_OUTPUT

      - name: Run Claude Code Review
        if: steps.diff.outputs.diff_size > 0
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are reviewing PR #${{ env.PR_NUMBER }} with ${{ steps.diff.outputs.files_changed }} files changed.

            Perform a comprehensive code review focusing on:
            1. **Correctness**: Logic errors, edge cases, potential bugs
            2. **Security**: Vulnerabilities, data exposure, injection risks
            3. **Performance**: Bottlenecks, inefficient algorithms, resource leaks
            4. **Maintainability**: Code clarity, documentation, test coverage
            5. **Architecture**: Design patterns, SOLID principles, coupling

            Review the changes and provide structured feedback:

            ## ðŸš¨ Critical Issues
            List any blocking issues that must be fixed

            ## ðŸ”’ Security Concerns
            Identify security vulnerabilities with OWASP mapping

            ## âš¡ Performance Considerations
            Note any performance impacts or optimizations needed

            ## âœ¨ Suggestions
            Non-blocking improvements for code quality

            ## âœ… Strengths
            Positive aspects of the implementation

            Provide specific file:line references and concrete fix examples.
            Keep feedback actionable and educational.

          claude_args: |
            {
              "model": "claude-opus-4-1-20250805",
              "max_tokens": 4000,
              "temperature": 0.3
            }
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}

      - name: Post Review Comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('claude_review_output.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ env.PR_NUMBER }},
              body: `## ðŸ¤– Claude AI Code Review\n\n${review}\n\n---\n*Generated by Claude Code (Opus 4.1)*`
            });

  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Security Scan
        uses: anthropics/claude-code-security-review@main
        with:
          comment-pr: true
          claude-api-key: ${{ secrets.CLAUDE_API_KEY }}
          exclude-directories: "node_modules,dist,build,vendor,.git"
          custom-security-scan-instructions: |
            Focus on OWASP Top 10 vulnerabilities:
            - A01: Broken Access Control
            - A02: Cryptographic Failures
            - A03: Injection
            - A04: Insecure Design
            - A05: Security Misconfiguration
            - A06: Vulnerable Components
            - A07: Authentication Failures
            - A08: Data Integrity Failures
            - A09: Security Logging Failures
            - A10: Server-Side Request Forgery

            Flag any hardcoded secrets, API keys, or credentials.
            Check for unsafe deserialization and XXE vulnerabilities.

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security_findings.json
          retention-days: 30

  dependency-audit:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: hashFiles('package.json')
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Run npm audit
        if: hashFiles('package.json')
        run: |
          npm audit --json > npm_audit.json || true
          if [ -s npm_audit.json ]; then
            vulnerabilities=$(jq '.metadata.vulnerabilities | .critical + .high' npm_audit.json)
            if [ "$vulnerabilities" -gt 0 ]; then
              echo "âš ï¸ Found $vulnerabilities high/critical vulnerabilities in dependencies"
              npm audit
            fi
          fi

      - name: Setup Python
        if: hashFiles('requirements.txt')
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Safety check
        if: hashFiles('requirements.txt')
        run: |
          pip install safety
          safety check --json > safety_report.json || true
          if [ -s safety_report.json ]; then
            echo "âš ï¸ Dependency vulnerabilities found:"
            safety check
          fi

  test-coverage:
    name: Test Coverage Check
    runs-on: ubuntu-latest
    if: hashFiles('package.json') || hashFiles('requirements.txt')
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Test Environment
        run: |
          if [ -f package.json ]; then
            npm ci
            npm test -- --coverage || true
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
            pip install pytest pytest-cov
            pytest --cov || true
          fi

      - name: Comment Coverage Report
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // This would parse and post coverage metrics
            console.log('Coverage reporting configured');

  review-summary:
    name: Review Summary
    runs-on: ubuntu-latest
    needs: [code-review, security-scan, dependency-audit, test-coverage]
    if: always()

    steps:
      - name: Generate Summary Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jobs = ${{ toJson(needs) }};
            let summary = '## ðŸ“Š AI Review Summary\n\n';

            summary += '| Check | Status |\n';
            summary += '|-------|--------|\n';

            for (const [job, status] of Object.entries(jobs)) {
              const emoji = status.result === 'success' ? 'âœ…' :
                           status.result === 'failure' ? 'âŒ' : 'âš ï¸';
              summary += `| ${job.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} | ${emoji} ${status.result} |\n`;
            }

            summary += '\n---\n*Review completed at ' + new Date().toISOString() + '*';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.pull_request.number }},
              body: summary
            });